
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin & Supervisor System (Terminal Style)</title>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;700&display=swap');
        body {
            font-family: 'Roboto Mono', monospace;
            background-color: #1a1a1a;
            color: #00ff00;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 2rem;
            box-sizing: border-box;
        }
        .container {
            width: 100%;
            max-width: 1200px;
        }
        .system-panel {
            background-color: #000000;
            border: 2px solid #00ff00;
            box-shadow: 0 0 10px #00ff00;
            padding: 2rem;
            margin-bottom: 2rem;
            animation: terminalGlow 2s infinite alternate;
        }
        @keyframes terminalGlow {
            from { box-shadow: 0 0 5px #00ff00; }
            to { box-shadow: 0 0 15px #00ff00; }
        }
        .login-card {
            max-width: 500px;
            margin: 0 auto;
        }
        input, select, textarea {
            background-color: #0d0d0d;
            border: 1px solid #00ff00;
            color: #00ff00;
            padding: 0.75rem;
            width: 100%;
            margin-top: 0.5rem;
            margin-bottom: 1rem;
            box-shadow: inset 0 0 5px #00ff0080;
        }
        input:focus, select:focus, textarea:focus {
            outline: none;
            box-shadow: 0 0 10px #00ff00;
        }
        button {
            background-color: #00aaff;
            color: #000000;
            font-weight: bold;
            padding: 0.75rem 1.5rem;
            border: 2px solid #00aaff;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        button.btn-primary { background-color: #00aaff; border-color: #00aaff; }
        button.btn-danger { background-color: #ff3333; border-color: #ff3333; }
        button.btn-warning { background-color: #ffff33; border-color: #ffff33; }
        button.btn-success { background-color: #00cc00; border-color: #00cc00; }
        button:hover {
            filter: brightness(1.2);
            box-shadow: 0 0 10px;
        }
        .text-neon-blue { color: #00aaff; }
        .text-neon-green { color: #00ff00; }
        .text-neon-red { color: #ff3333; }
        .text-neon-yellow { color: #ffff33; }
        .flex-container {
            display: flex;
            gap: 2rem;
            flex-wrap: wrap;
        }
        .flex-container > div {
            flex: 1;
            min-width: 400px;
        }
        .grid-container {
            display: grid;
            gap: 1rem;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
        }
        .station-card {
            border: 1px dashed #00ff00;
            padding: 1rem;
            text-align: center;
        }
        .station-card.occupied {
            border-color: #ff3333;
            background-color: rgba(255, 51, 51, 0.1);
        }
        .station-card.unoccupied {
            border-color: #00cc00;
            background-color: rgba(0, 204, 0, 0.1);
        }
        .station-card.needs-maintenance {
            border-color: #ffff33;
            background-color: rgba(255, 255, 51, 0.1);
        }
        .chat-container {
            height: 300px;
            overflow-y: auto;
            border: 1px solid #00ff00;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        .chat-message {
            max-width: 75%;
            padding: 0.5rem;
            border: 1px solid;
        }
        .chat-message.admin {
            align-self: flex-end;
            background-color: rgba(0, 170, 255, 0.2);
            border-color: #00aaff;
        }
        .chat-message.supervisor {
            align-self: flex-start;
            background-color: rgba(0, 204, 0, 0.2);
            border-color: #00cc00;
        }
        .message-box {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #000;
            border: 2px solid #00ff00;
            box-shadow: 0 0 10px #00ff00;
            padding: 2rem;
            z-index: 1000;
            color: #00ff00;
            display: none;
        }
        .broadcast-message {
            position: fixed;
            top: 1rem;
            left: 50%;
            transform: translateX(-50%);
            background: #ff3333;
            color: #000;
            font-weight: bold;
            padding: 1rem 2rem;
            border: 2px solid #000;
            box-shadow: 0 0 15px #ff3333;
            z-index: 2000;
            display: none;
            animation: pulseGlow 1s infinite alternate;
        }
        @keyframes pulseGlow {
            from { box-shadow: 0 0 5px #ff3333; }
            to { box-shadow: 0 0 20px #ff3333; }
        }
        .report-section {
            background-color: #0d0d0d;
            padding: 1rem;
            border: 1px solid #00ff00;
            margin-top: 1rem;
        }
        .password-strength {
            font-size: 0.8rem;
            margin-top: -0.5rem;
            margin-bottom: 0.5rem;
            text-align: left;
        }
        .password-strength.weak { color: #ff3333; }
        .password-strength.medium { color: #ffff33; }
        .password-strength.strong { color: #00cc00; }
        .blinking-dot {
            height: 10px;
            width: 10px;
            background-color: #ff3333;
            border-radius: 50%;
            display: inline-block;
            margin-left: 5px;
            animation: blink 1s linear infinite;
        }
        @keyframes blink {
            50% { opacity: 0; }
        }
        .kiosk-card {
            background-color: #000000;
            border: 1px solid #00ff00;
            padding: 1rem;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="container">
        <div id="broadcast-message" class="broadcast-message">
            <p id="broadcast-text"></p>
            <button onclick="dismissBroadcast()" style="background: #000; color: #ff3333; border-color: #ff3333;">DISMISS</button>
        </div>

        <div id="login-screen" class="system-panel login-card">
            <h1 class="text-neon-green text-3xl font-bold mb-4 text-center">ACCESS TERMINAL</h1>
            <p id="welcome-message" class="text-center text-neon-green mb-4"></p>
            <div class="flex flex-col items-center mb-6">
                 <div class="p-4 rounded-full mb-2 border-2 border-dashed border-neon-green">
                    <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="#00ff00" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-terminal-square"><path d="m7 11 2 2 4-4"/><rect width="18" height="18" x="3" y="3" rx="2"/></svg>
                </div>
            </div>
            <div class="flex justify-center mb-8">
                <button id="show-admin-login-btn" class="btn-primary w-1/3">ADMIN</button>
                <button id="show-supervisor-login-btn" class="btn-success w-1/3">SUPERVISOR</button>
                <button id="show-kiosk-btn" class="btn-warning w-1/3">KIOSK</button>
            </div>
            <form id="admin-login-form">
                <h2 class="text-neon-blue text-center mb-4">ADMIN LOGIN</h2>
                <input type="text" id="admin-username" placeholder="Username" required>
                <input type="password" id="admin-password" placeholder="Password" required>
                <input type="password" id="admin-secret-code" placeholder="Secret Code" required>
                <button type="submit" class="btn-primary w-full">LOG IN</button>
                <p id="admin-login-message" class="text-center text-neon-red mt-2"></p>
            </form>
            <form id="supervisor-login-form" style="display:none;">
                <h2 class="text-neon-green text-center mb-4">SUPERVISOR LOGIN</h2>
                <input type="text" id="supervisor-id" placeholder="ID" required>
                <input type="password" id="supervisor-password" placeholder="Password" required>
                <button type="submit" class="btn-success w-full">LOG IN</button>
                <button type="button" id="forgot-password-btn" class="btn-warning w-full mt-2">FORGOT PASSWORD?</button>
                <p id="supervisor-login-message" class="text-center text-neon-red mt-2"></p>
            </form>
        </div>
        <div id="admin-dashboard" style="display:none;">
            <div class="system-panel">
                <div class="flex-container">
                    <h1 class="text-neon-blue text-3xl font-bold">ADMIN DASHBOARD</h1>
                    <button id="admin-logout-btn" class="btn-danger">LOGOUT</button>
                </div>
                <div class="flex-container mt-4">
                    <div class="system-panel">
                        <h2 class="text-neon-blue text-2xl font-bold mb-4">REGISTER STUDENT</h2>
                        <form id="student-register-form">
                            <input type="text" id="student-name" placeholder="Student Name" required>
                            <input type="text" id="student-id" placeholder="Student ID" required>
                            <input type="text" id="student-hostel" placeholder="Hostel.Room" required>
                            <input type="text" id="student-program" placeholder="Program of Study" required>
                            <input type="number" id="student-year" placeholder="Year of Study" required>
                            <label class="text-neon-green">PHOTO UPLOAD</label>
                            <input type="file" id="student-photo">
                            <button type="submit" class="btn-primary w-full mt-4">REGISTER</button>
                            <p id="student-register-message" class="text-center mt-2"></p>
                        </form>
                    </div>
                    <div class="system-panel">
                        <h2 class="text-neon-blue text-2xl font-bold mb-4">REGISTER SUPERVISOR</h2>
                        <form id="supervisor-register-form">
                            <input type="text" id="supervisor-name" placeholder="Supervisor Name" required>
                            <input type="text" id="supervisor-reg-id" placeholder="ID" required>
                            <input type="email" id="supervisor-email" placeholder="Email" required>
                            <input type="password" id="supervisor-reg-password" placeholder="Password" required>
                            <div id="supervisor-password-strength" class="password-strength"></div>
                            <label class="text-neon-green">PHOTO UPLOAD</label>
                            <input type="file" id="supervisor-photo">
                            <button type="submit" class="btn-primary w-full mt-4">REGISTER</button>
                            <p id="supervisor-register-message" class="text-center mt-2"></p>
                        </form>
                    </div>
                </div>
                <div class="system-panel mt-4">
                    <h2 class="text-neon-blue text-2xl font-bold mb-4">USER MANAGEMENT</h2>
                    <input type="text" id="user-search-input" placeholder="SEARCH STUDENT/SUPERVISOR BY NAME OR ID">
                    <div id="user-list"></div>
                </div>
                <div class="system-panel mt-4">
                    <h2 class="text-neon-blue text-2xl font-bold mb-4">SYSTEM ACTIVITIES & REPORTS</h2>
                    <div class="flex-container">
                        <div class="system-panel">
                            <h3 class="text-xl text-neon-green">ACTIVITY LOG</h3>
                            <ul id="activity-log" style="height: 150px; overflow-y: auto;"></ul>
                        </div>
                        <div class="system-panel">
                            <h3 class="text-xl text-neon-green">REPORT SUMMARY</h3>
                            <p>TOTAL SUPERVISORS: <span id="report-supervisors">0</span></p>
                            <p>TOTAL STUDENTS: <span id="report-students">0</span></p>
                            <p>TOTAL STATIONS: <span id="report-total-stations">0</span></p>
                            <p>OCCUPIED STATIONS: <span id="report-occupied-stations">0</span></p>
                            <p>UNOCCUPIED STATIONS: <span id="report-unoccupied-stations">0</span></p>
                            <button onclick="generateReport()" class="btn-success mt-2">GENERATE REPORT</button>
                        </div>
                    </div>
                </div>
                <div class="system-panel mt-4">
                    <h2 class="text-neon-blue text-2xl font-bold mb-4">CUSTOM REPORTS</h2>
                    <form id="custom-report-form">
                        <label for="report-start-date" class="text-neon-green">Start Date:</label>
                        <input type="date" id="report-start-date">
                        <label for="report-end-date" class="text-neon-green">End Date:</label>
                        <input type="date" id="report-end-date">
                        <label class="text-neon-green">Select Metrics:</label>
                        <div style="display: flex; flex-direction: column; gap: 0.5rem; margin-bottom: 1rem;">
                            <label><input type="checkbox" name="metric" value="mostUsed" checked> Most Used Stations</label>
                            <label><input type="checkbox" name="metric" value="leastUsed" checked> Least Used Stations</label>
                            <label><input type="checkbox" name="metric" value="averageSession"> Average Session Time</label>
                        </div>
                        <button type="submit" class="btn-primary w-full">GENERATE CUSTOM REPORT</button>
                    </form>
                    <div id="custom-report-output" class="report-section" style="display: none;"></div>
                </div>
                <div class="system-panel mt-4">
                    <h2 class="text-neon-blue text-2xl font-bold mb-4">STATION STATUS</h2>
                    <div id="station-status-admin" class="grid-container"></div>
                </div>
                <div class="system-panel mt-4">
                    <h2 class="text-neon-blue text-2xl font-bold mb-4">EMERGENCY BROADCAST</h2>
                    <form id="broadcast-form">
                        <textarea id="broadcast-message-input" placeholder="Type urgent message here..." rows="2" required></textarea>
                        <button type="submit" class="btn-danger w-full mt-2">SEND BROADCAST</button>
                    </form>
                </div>
                <div class="system-panel mt-4">
                    <div style="display: flex; align-items: center; gap: 1rem;">
                        <h2 class="text-neon-blue text-2xl font-bold">CHAT WITH SUPERVISORS</h2>
                        <span id="admin-chat-notification" class="blinking-dot" style="display:none;"></span>
                    </div>
                    <div id="admin-chat-box" class="chat-container"></div>
                    <form id="admin-chat-form" style="display:flex; gap: 1rem; margin-top: 1rem;">
                        <input type="text" id="admin-chat-input" placeholder="> TYPE MESSAGE..." style="flex-grow: 1;" required>
                        <button type="submit" class="btn-primary">SEND</button>
                    </form>
                </div>
            </div>
        </div>
        <div id="supervisor-dashboard" style="display:none;">
            <div class="system-panel">
                <div class="flex-container">
                    <div style="display: flex; align-items: center; gap: 1rem;">
                        <div id="supervisor-profile-photo" style="width: 48px; height: 48px; border-radius: 50%; border: 1px dashed #00ff00; overflow: hidden; display: flex; align-items: center; justify-content: center; background: #333;">
                            <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="#00ff00" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-user"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
                        </div>
                        <h1 class="text-neon-green text-3xl font-bold">SUPERVISOR DASHBOARD</h1>
                    </div>
                    <div style="display:flex; gap: 1rem;">
                        <button id="supervisor-change-password-btn" class="btn-primary">CHANGE PASSWORD</button>
                        <button id="supervisor-logout-btn" class="btn-danger">LOGOUT</button>
                    </div>
                </div>
                <div class="flex-container mt-4">
                    <div class="system-panel">
                        <h2 class="text-neon-green text-2xl font-bold mb-4">ASSIGN STATION</h2>
                        <form id="station-assignment-form">
                            <select id="station-select" required>
                                <option value="">SELECT A STATION</option>
                            </select>
                            <input type="text" id="student-lookup-input" placeholder="ENTER STUDENT ID OR NAME" required>
                            <div id="student-profile-preview" style="display: none; align-items: center; gap: 1rem; margin-top: 1rem;">
                                <img id="student-photo-preview" src="" alt="Student Photo" style="width: 64px; height: 64px; border-radius: 50%; object-fit: cover; border: 1px dashed #00ff00;">
                                <div id="student-details-preview"></div>
                            </div>
                            <label class="text-neon-green">Session Duration (minutes)</label>
                            <input type="number" id="session-duration" placeholder="e.g., 60" min="15" value="60" required>
                            <p id="station-assignment-message" class="text-center mt-2"></p>
                            <button type="submit" class="btn-success w-full mt-4">ASSIGN STATION</button>
                        </form>
                    </div>
                    <div class="system-panel">
                        <h2 class="text-neon-green text-2xl font-bold mb-4">STATION STATUS</h2>
                        <div id="station-status-supervisor" class="grid-container"></div>
                    </div>
                </div>
                <div class="flex-container mt-4">
                    <div class="system-panel">
                        <h2 class="text-neon-green text-2xl font-bold mb-4">REPORT STATION ISSUES</h2>
                        <form id="issue-report-form">
                            <select id="issue-station-select" required>
                                <option value="">SELECT STATION</option>
                            </select>
                            <select id="issue-type" required>
                                <option value="">SELECT ISSUE TYPE</option>
                                <option value="Needs Maintenance">Needs Maintenance</option>
                                <option value="Out of Service">Out of Service</option>
                            </select>
                            <textarea id="issue-description" placeholder="DESCRIBE THE ISSUE..." rows="4" required></textarea>
                            <button type="submit" class="btn-warning w-full mt-4">REPORT ISSUE</button>
                        </form>
                    </div>
                    <div class="system-panel">
                        <div style="display: flex; align-items: center; gap: 1rem;">
                            <h2 class="text-neon-green text-2xl font-bold mb-4">CHAT WITH ADMIN</h2>
                            <span id="supervisor-chat-notification" class="blinking-dot" style="display:none;"></span>
                        </div>
                        <div id="supervisor-chat-box" class="chat-container"></div>
                        <form id="supervisor-chat-form" style="display:flex; gap: 1rem; margin-top: 1rem;">
                            <input type="text" id="supervisor-chat-input" placeholder="> REPLY TO ADMIN..." style="flex-grow: 1;" required>
                            <button type="submit" class="btn-success">REPLY</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
        <div id="kiosk-screen" style="display:none;">
            <div class="system-panel">
                <div class="flex-container">
                    <h1 class="text-neon-yellow text-3xl font-bold">STUDENT KIOSK</h1>
                    <button id="kiosk-back-btn" class="btn-warning">BACK TO LOGIN</button>
                </div>
                <div class="system-panel mt-4">
                    <h2 class="text-neon-yellow text-2xl font-bold mb-4">STATION STATUS OVERVIEW</h2>
                    <div id="kiosk-station-list" class="grid-container"></div>
                </div>
            </div>
        </div>
        <div id="password-reset-modal" class="message-box">
            <h3 class="text-neon-yellow text-2xl mb-4">RESET PASSWORD</h3>
            <form id="password-reset-form">
                <input type="text" id="reset-name" placeholder="Name" required>
                <input type="text" id="reset-id" placeholder="ID" required>
                <input type="password" id="reset-old-password" placeholder="Current Password" required>
                <input type="password" id="reset-new-password" placeholder="New Password" required>
                <button type="submit" class="btn-warning w-full mt-4">RESET PASSWORD</button>
                <button type="button" id="cancel-reset-btn" class="btn-danger w-full mt-2">CANCEL</button>
                <p id="reset-message" class="text-center text-neon-red mt-2"></p>
            </form>
        </div>
        <div id="password-change-modal" class="message-box">
            <h3 class="text-neon-blue text-2xl mb-4">CHANGE PASSWORD</h3>
            <form id="password-change-form">
                <input type="password" id="current-password" placeholder="Current Password" required>
                <input type="password" id="new-password" placeholder="New Password" required>
                <div id="new-password-strength" class="password-strength"></div>
                <button type="submit" class="btn-primary w-full mt-4">CHANGE PASSWORD</button>
                <button type="button" id="cancel-change-btn" class="btn-danger w-full mt-2">CANCEL</button>
                <p id="change-password-message" class="text-center text-neon-red mt-2"></p>
            </form>
        </div>
        <div id="user-detail-modal" class="message-box" style="max-width: 600px;">
            <h3 class="text-neon-blue text-2xl mb-4" id="user-modal-title"></h3>
            <form id="edit-user-form">
                <div id="user-modal-content"></div>
                <button type="submit" class="btn-primary w-full mt-4">SAVE CHANGES</button>
                <button type="button" onclick="closeModal('user-detail-modal')" class="btn-danger w-full mt-2">CLOSE</button>
            </form>
        </div>
    </div>
    <script>
        // --- Data Storage (In-memory Simulation) ---
        let appData = {
            students: [],
            supervisors: [],
            stations: [],
            chatMessages: [],
            activities: [],
            currentUser: null,
            broadcastMessage: null,
            stationUsageHistory: [],
            maintenanceLog: []
        };
        let sessionTimerInterval;
        let chatNotificationInterval;
        let lastAdminMessageTime = 0;
        let lastSupervisorMessageTime = 0;

        function initializeData() {
            appData.admin = { username: 'given', password: '200320@1', secretCode: '16342950' };
            for (let i = 1; i <= 100; i++) {
                appData.stations.push({
                    id: i,
                    isOccupied: false,
                    assignedTo: null,
                    assignedBy: null,
                    issue: null,
                    sessionEndTime: null,
                    statusFlag: null
                });
            }
        }
        // --- UI Element References ---
        const loginScreen = document.getElementById('login-screen');
        const adminDashboard = document.getElementById('admin-dashboard');
        const supervisorDashboard = document.getElementById('supervisor-dashboard');
        const kioskScreen = document.getElementById('kiosk-screen');
        const adminLoginForm = document.getElementById('admin-login-form');
        const supervisorLoginForm = document.getElementById('supervisor-login-form');
        const showAdminLoginBtn = document.getElementById('show-admin-login-btn');
        const showSupervisorLoginBtn = document.getElementById('show-supervisor-login-btn');
        const showKioskBtn = document.getElementById('show-kiosk-btn');
        const kioskBackBtn = document.getElementById('kiosk-back-btn');
        const adminLoginMessage = document.getElementById('admin-login-message');
        const supervisorLoginMessage = document.getElementById('supervisor-login-message');
        const passwordResetModal = document.getElementById('password-reset-modal');
        const forgotPasswordBtn = document.getElementById('forgot-password-btn');
        const passwordResetForm = document.getElementById('password-reset-form');
        const cancelResetBtn = document.getElementById('cancel-reset-btn');
        const studentRegisterForm = document.getElementById('student-register-form');
        const supervisorRegisterForm = document.getElementById('supervisor-register-form');
        const supervisorRegPasswordInput = document.getElementById('supervisor-reg-password');
        const supervisorPasswordStrength = document.getElementById('supervisor-password-strength');
        const studentRegisterMessage = document.getElementById('student-register-message');
        const supervisorRegisterMessage = document.getElementById('supervisor-register-message');
        const userList = document.getElementById('user-list');
        const userSearchInput = document.getElementById('user-search-input');
        const activityLog = document.getElementById('activity-log');
        const stationStatusAdmin = document.getElementById('station-status-admin');
        const adminChatBox = document.getElementById('admin-chat-box');
        const adminChatForm = document.getElementById('admin-chat-form');
        const stationAssignmentForm = document.getElementById('station-assignment-form');
        const stationSelect = document.getElementById('station-select');
        const studentLookupInput = document.getElementById('student-lookup-input');
        const studentLookupMessage = document.getElementById('station-assignment-message');
        const studentProfilePreview = document.getElementById('student-profile-preview');
        const studentPhotoPreview = document.getElementById('student-photo-preview');
        const studentDetailsPreview = document.getElementById('student-details-preview');
        const stationStatusSupervisor = document.getElementById('station-status-supervisor');
        const issueReportForm = document.getElementById('issue-report-form');
        const issueStationSelect = document.getElementById('issue-station-select');
        const supervisorChatBox = document.getElementById('supervisor-chat-box');
        const supervisorChatForm = document.getElementById('supervisor-chat-form');
        const passwordChangeModal = document.getElementById('password-change-modal');
        const supervisorChangePasswordBtn = document.getElementById('supervisor-change-password-btn');
        const passwordChangeForm = document.getElementById('password-change-form');
        const cancelChangeBtn = document.getElementById('cancel-change-btn');
        const newPasswordInput = document.getElementById('new-password');
        const newPasswordStrength = document.getElementById('new-password-strength');
        const supervisorProfilePhoto = document.getElementById('supervisor-profile-photo');
        const welcomeMessage = document.getElementById('welcome-message');
        const broadcastMessageEl = document.getElementById('broadcast-message');
        const broadcastTextEl = document.getElementById('broadcast-text');
        const customReportForm = document.getElementById('custom-report-form');
        const customReportOutput = document.getElementById('custom-report-output');
        const broadcastForm = document.getElementById('broadcast-form');
        const userDetailModal = document.getElementById('user-detail-modal');
        const userModalTitle = document.getElementById('user-modal-title');
        const userModalContent = document.getElementById('user-modal-content');
        const kioskStationList = document.getElementById('kiosk-station-list');
        const adminChatNotification = document.getElementById('admin-chat-notification');
        const supervisorChatNotification = document.getElementById('supervisor-chat-notification');
        // --- Authentication & Page Switching ---
        function updateWelcomeMessage() {
            const now = new Date();
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit', second: '2-digit' };
            welcomeMessage.textContent = `SYSTEM ACCESS. CURRENT TIME: ${now.toLocaleDateString('en-US', options)}`;
        }
        function toggleLoginForms(formToShow) {
            const adminLogin = document.getElementById('admin-login-form');
            const supervisorLogin = document.getElementById('supervisor-login-form');
            const adminBtn = document.getElementById('show-admin-login-btn');
            const supervisorBtn = document.getElementById('show-supervisor-login-btn');
            if (formToShow === 'admin') {
                adminLogin.style.display = 'block';
                supervisorLogin.style.display = 'none';
                adminBtn.style.backgroundColor = '#00aaff';
                supervisorBtn.style.backgroundColor = '#00cc00';
            } else {
                supervisorLogin.style.display = 'block';
                adminLogin.style.display = 'none';
                supervisorBtn.style.backgroundColor = '#00aaff';
                adminBtn.style.backgroundColor = '#00cc00';
            }
        }
        showAdminLoginBtn.addEventListener('click', () => toggleLoginForms('admin'));
        showSupervisorLoginBtn.addEventListener('click', () => toggleLoginForms('supervisor'));
        showKioskBtn.addEventListener('click', () => showScreen('kiosk-screen'));
        kioskBackBtn.addEventListener('click', () => showScreen('login-screen'));
        adminLoginForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const username = e.target['admin-username'].value;
            const password = e.target['admin-password'].value;
            const secretCode = e.target['admin-secret-code'].value;
            if (username === appData.admin.username && password === appData.admin.password && secretCode === appData.admin.secretCode) {
                appData.currentUser = { role: 'admin' };
                showScreen('admin-dashboard');
                renderAdminDashboard();
                logActivity('Admin logged in.');
                startSessionTimers();
                adminChatBox.addEventListener('click', () => { adminChatNotification.style.display = 'none'; });
            } else {
                adminLoginMessage.textContent = 'INVALID CREDENTIALS.';
            }
        });
        supervisorLoginForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const id = e.target['supervisor-id'].value;
            const password = e.target['supervisor-password'].value;
            const supervisor = appData.supervisors.find(sup => sup.id === id);
            if (supervisor && supervisor.password === password) {
                appData.currentUser = { role: 'supervisor', id: supervisor.id, name: supervisor.name, photo: supervisor.photo };
                showScreen('supervisor-dashboard');
                renderSupervisorDashboard();
                logActivity(`Supervisor ${supervisor.name} logged in.`);
                startSessionTimers();
                supervisorChatBox.addEventListener('click', () => { supervisorChatNotification.style.display = 'none'; });
            } else {
                supervisorLoginMessage.textContent = 'INVALID ID OR PASSWORD.';
            }
        });
        forgotPasswordBtn.addEventListener('click', () => {
            passwordResetModal.style.display = 'block';
        });
        cancelResetBtn.addEventListener('click', () => {
            passwordResetModal.style.display = 'none';
        });
        passwordResetForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const name = e.target['reset-name'].value;
            const id = e.target['reset-id'].value;
            const oldPassword = e.target['reset-old-password'].value;
            const newPassword = e.target['reset-new-password'].value;
            const supervisor = appData.supervisors.find(sup => sup.id === id && sup.name === name);
            const resetMessage = document.getElementById('reset-message');
            if (supervisor && supervisor.password === oldPassword) {
                supervisor.password = newPassword;
                passwordResetModal.style.display = 'none';
                resetMessage.textContent = '';
                alert('PASSWORD RESET SUCCESSFUL!');
                logActivity(`PASSWORD FOR SUPERVISOR ${supervisor.name} (ID: ${supervisor.id}) WAS RESET.`);
            } else {
                resetMessage.textContent = 'DETAILS DO NOT MATCH. PLEASE CHECK YOUR INFORMATION.';
            }
        });
        document.getElementById('admin-logout-btn').addEventListener('click', () => {
            logActivity('Admin logged out.');
            appData.currentUser = null;
            showScreen('login-screen');
            clearInterval(sessionTimerInterval);
        });
        document.getElementById('supervisor-logout-btn').addEventListener('click', () => {
            logActivity(`Supervisor ${appData.currentUser.name} logged out.`);
            appData.currentUser = null;
            showScreen('login-screen');
            clearInterval(sessionTimerInterval);
        });
        function showScreen(screenId) {
            loginScreen.style.display = 'none';
            adminDashboard.style.display = 'none';
            supervisorDashboard.style.display = 'none';
            kioskScreen.style.display = 'none';
            document.getElementById(screenId).style.display = 'block';
            if (screenId === 'kiosk-screen') {
                renderKioskStations();
            }
        }
        // --- Admin Dashboard Functions ---
        function renderAdminDashboard() {
            renderUserList();
            renderStationStatusAdmin();
            renderChat(adminChatBox, 'admin');
        }
        supervisorRegPasswordInput.addEventListener('input', (e) => {
            const password = e.target.value;
            checkPasswordStrength(password, supervisorPasswordStrength);
        });
        passwordChangeForm.addEventListener('input', (e) => {
            if (e.target.id === 'new-password') {
                checkPasswordStrength(e.target.value, newPasswordStrength);
            }
        });
        function checkPasswordStrength(password, element) {
            const strongRegex = new RegExp("^(?=.*[a-z])(?=.*[A-Z])(?=.*[0-9])(?=.*[!@#\\$%\\^&\\*])(?=.{8,})");
            const mediumRegex = new RegExp("^(((?=.*[a-z])(?=.*[A-Z]))|((?=.*[a-z])(?=.*[0-9]))|((?=.*[A-Z])(?=.*[0-9])))(?=.{6,})");
            if (strongRegex.test(password)) {
                element.textContent = 'Strong';
                element.className = 'password-strength strong';
            } else if (mediumRegex.test(password)) {
                element.textContent = 'Medium';
                element.className = 'password-strength medium';
            } else {
                element.textContent = 'Weak';
                element.className = 'password-strength weak';
            }
        }
        studentRegisterForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const studentId = e.target['student-id'].value;
            if (appData.students.find(s => s.id === studentId)) {
                studentRegisterMessage.textContent = `ERROR: STUDENT WITH ID ${studentId} ALREADY EXISTS.`;
                studentRegisterMessage.className = 'text-center mt-2 text-neon-red';
                return;
            }
            const student = {
                name: e.target['student-name'].value,
                id: studentId,
                hostel: e.target['student-hostel'].value,
                program: e.target['student-program'].value,
                year: e.target['student-year'].value,
                photo: e.target['student-photo'].files[0] ? URL.createObjectURL(e.target['student-photo'].files[0]) : null,
                stationHistory: []
            };
            appData.students.push(student);
            studentRegisterForm.reset();
            studentRegisterMessage.textContent = `STUDENT ${student.name} REGISTERED SUCCESSFULLY!`;
            studentRegisterMessage.className = 'text-center mt-2 text-neon-green';
            logActivity(`ADMIN REGISTERED STUDENT ${student.name} (ID: ${student.id}).`);
            renderUserList();
        });
        supervisorRegisterForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const supervisorId = e.target['supervisor-reg-id'].value;
            if (appData.supervisors.find(s => s.id === supervisorId)) {
                supervisorRegisterMessage.textContent = `ERROR: SUPERVISOR WITH ID ${supervisorId} ALREADY EXISTS.`;
                supervisorRegisterMessage.className = 'text-center mt-2 text-neon-red';
                return;
            }
            const supervisor = {
                name: e.target['supervisor-name'].value,
                id: supervisorId,
                email: e.target['supervisor-email'].value,
                password: e.target['supervisor-reg-password'].value,
                photo: e.target['supervisor-photo'].files[0] ? URL.createObjectURL(e.target['supervisor-photo'].files[0]) : null,
                isBlocked: false
            };
            appData.supervisors.push(supervisor);
            supervisorRegisterForm.reset();
            supervisorPasswordStrength.textContent = '';
            supervisorRegisterMessage.textContent = `SUPERVISOR ${supervisor.name} REGISTERED SUCCESSFULLY!`;
            supervisorRegisterMessage.className = 'text-center mt-2 text-neon-green';
            renderUserList();
            logActivity(`ADMIN REGISTERED NEW SUPERVISOR ${supervisor.name} (ID: ${supervisor.id}).`);
        });
        userSearchInput.addEventListener('input', () => {
            renderUserList();
        });
        function renderUserList() {
            userList.innerHTML = '';
            const searchTerm = userSearchInput.value.toLowerCase();
            const allUsers = [...appData.students, ...appData.supervisors];
            const filteredUsers = allUsers.filter(user =>
                user.name.toLowerCase().includes(searchTerm) || user.id.toLowerCase().includes(searchTerm)
            );
            filteredUsers.forEach(user => {
                const userItem = document.createElement('div');
                userItem.className = 'system-panel flex-container';
                const photoHtml = user.photo ? `<img src="${user.photo}" alt="${user.name}" style="width: 48px; height: 48px; border-radius: 50%; object-fit: cover; border: 1px dashed #00ff00;">` : `<div style="width: 48px; height: 48px; display: flex; align-items: center; justify-content: center; background: #333; border-radius: 50%;">N/A</div>`;
                const userType = user.hasOwnProperty('program') ? 'Student' : 'Supervisor';
                const statusHtml = user.isBlocked ? `<p class="text-xs text-neon-red">BLOCKED</p>` : `<p class="text-xs text-neon-green">ACTIVE</p>`;
                userItem.innerHTML = `
                    <div style="display:flex; gap: 1rem; align-items: center;">
                        ${photoHtml}
                        <div>
                            <p class="text-xl">${user.name} (${user.id})</p>
                            <p class="text-sm">${userType}: ${user.email || user.program}</p>
                            ${userType === 'Supervisor' ? statusHtml : ''}
                        </div>
                    </div>
                    <div style="display: flex; gap: 0.5rem;">
                        ${userType === 'Supervisor' ? `
                            <button onclick="toggleSupervisorBlock('${user.id}')" class="btn-warning" style="background-color: ${user.isBlocked ? '#00cc00' : '#ffff33'}; border-color: ${user.isBlocked ? '#00cc00' : '#ffff33'}; color: #000;">
                                ${user.isBlocked ? 'UNBLOCK' : 'BLOCK'}
                            </button>
                        ` : ''}
                        <button onclick="showUserDetail('${user.id}', '${userType.toLowerCase()}')" class="btn-primary" style="background-color: #00aaff; border-color: #00aaff; color: #000;">VIEW / EDIT</button>
                        <button onclick="deleteUser('${user.id}', '${userType.toLowerCase()}')" class="btn-danger" style="background-color: #ff3333; border-color: #ff3333; color: #000;">DELETE</button>
                    </div>
                `;
                userList.appendChild(userItem);
            });
        }
        window.showUserDetail = (id, type) => {
            const user = type === 'student' ? appData.students.find(s => s.id === id) : appData.supervisors.find(s => s.id === id);
            if (!user) return;
            userModalTitle.textContent = `${type.toUpperCase()} PROFILE: ${user.name}`;
            let contentHtml = `<input type="hidden" id="edit-user-id" value="${user.id}">`;
            contentHtml += `<input type="hidden" id="edit-user-type" value="${type}">`;
            contentHtml += `<label class="text-neon-green">Name:</label><input type="text" id="edit-name" value="${user.name}" required>`;
            contentHtml += `<label class="text-neon-green">ID:</label><input type="text" value="${user.id}" disabled>`;
            if (type === 'student') {
                contentHtml += `<label class="text-neon-green">Hostel:</label><input type="text" id="edit-hostel" value="${user.hostel}" required>`;
                contentHtml += `<label class="text-neon-green">Program:</label><input type="text" id="edit-program" value="${user.program}" required>`;
                contentHtml += `<label class="text-neon-green">Year:</label><input type="number" id="edit-year" value="${user.year}" required>`;
                contentHtml += `<h4 class="text-xl text-neon-yellow mt-4">STATION USAGE HISTORY:</h4><ul style="height: 150px; overflow-y: auto; border: 1px dashed #ffff33; padding: 1rem;">`;
                if(user.stationHistory && user.stationHistory.length > 0) {
                    user.stationHistory.forEach(hist => {
                        contentHtml += `<li>STATION ${hist.stationId} | ASSIGNED: ${new Date(hist.startTime).toLocaleString()}</li>`;
                    });
                } else {
                    contentHtml += `<li>NO USAGE HISTORY FOUND.</li>`;
                }
                contentHtml += `</ul>`;
            } else {
                contentHtml += `<label class="text-neon-green">Email:</label><input type="email" id="edit-email" value="${user.email}" required>`;
                contentHtml += `<h4 class="text-xl text-neon-yellow mt-4">ASSIGNED STUDENTS:</h4><ul style="height: 150px; overflow-y: auto; border: 1px dashed #ffff33; padding: 1rem;">`;
                const assignedStudents = appData.stations.filter(s => s.assignedBy === user.name && s.isOccupied);
                if(assignedStudents.length > 0) {
                    assignedStudents.forEach(station => {
                        contentHtml += `<li>STATION ${station.id}: ${station.assignedTo.name}</li>`;
                    });
                } else {
                    contentHtml += `<li>NO STUDENTS CURRENTLY ASSIGNED.</li>`;
                }
                contentHtml += `</ul>`;
            }
            userModalContent.innerHTML = contentHtml;
            userDetailModal.style.display = 'block';
        };
        document.getElementById('edit-user-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const id = e.target['edit-user-id'].value;
            const type = e.target['edit-user-type'].value;
            if (type === 'student') {
                const student = appData.students.find(s => s.id === id);
                if (student) {
                    student.name = e.target['edit-name'].value;
                    student.hostel = e.target['edit-hostel'].value;
                    student.program = e.target['edit-program'].value;
                    student.year = e.target['edit-year'].value;
                    logActivity(`ADMIN UPDATED STUDENT ${student.name}'s details.`);
                }
            } else {
                const supervisor = appData.supervisors.find(s => s.id === id);
                if (supervisor) {
                    supervisor.name = e.target['edit-name'].value;
                    supervisor.email = e.target['edit-email'].value;
                    logActivity(`ADMIN UPDATED SUPERVISOR ${supervisor.name}'s details.`);
                }
            }
            closeModal('user-detail-modal');
            renderUserList();
        });
        window.closeModal = (id) => {
            document.getElementById(id).style.display = 'none';
        };
        window.toggleSupervisorBlock = (id) => {
            const supervisor = appData.supervisors.find(sup => sup.id === id);
            if (supervisor) {
                supervisor.isBlocked = !supervisor.isBlocked;
                renderUserList();
                logActivity(`ADMIN ${supervisor.isBlocked ? 'BLOCKED' : 'UNBLOCKED'} SUPERVISOR ${supervisor.name}.`);
            }
        };
        window.deleteUser = (id, type) => {
            const userArray = type === 'student' ? appData.students : appData.supervisors;
            const userIndex = userArray.findIndex(user => user.id === id);
            if (userIndex !== -1) {
                const userName = userArray[userIndex].name;
                userArray.splice(userIndex, 1);
                renderUserList();
                logActivity(`ADMIN DELETED ${type.toUpperCase()} ${userName} (ID: ${id}).`);
            }
        };
        function renderStationStatusAdmin() {
            stationStatusAdmin.innerHTML = '';
            appData.stations.forEach(station => {
                let statusClass = station.isOccupied ? 'occupied' : 'unoccupied';
                if (station.statusFlag) {
                    statusClass = 'needs-maintenance';
                }
                const statusText = station.isOccupied ? 'OCCUPIED' : (station.statusFlag ? station.statusFlag.toUpperCase() : 'UNOCCUPIED');
                const assignedDetails = station.isOccupied ? `
                    <p class="text-sm">ASSIGNED TO: ${station.assignedTo.name}</p>
                    <p class="text-sm">ASSIGNED BY: ${station.assignedBy}</p>
                    <p class="text-sm">TIME LEFT: <span id="timer-${station.id}-admin">--:--</span></p>
                    <button onclick="unassignStation(${station.id}, 'admin')" class="btn-danger w-full mt-2" style="font-size: 0.75rem; padding: 0.25rem;">UNASSIGN</button>
                ` : '';
                const issueDetails = station.issue ? `
                    <p class="text-xs text-neon-yellow mt-2">ISSUE: ${station.issue}</p>
                ` : '';
                const stationCard = document.createElement('div');
                stationCard.className = `station-card ${statusClass}`;
                stationCard.innerHTML = `
                    <h3 class="text-xl font-bold">STATION ${station.id}</h3>
                    <p class="text-sm font-bold">${statusText}</p>
                    ${assignedDetails}
                    ${issueDetails}
                `;
                stationStatusAdmin.appendChild(stationCard);
            });
        }
        window.unassignStation = (id, unassignedBy) => {
            const station = appData.stations.find(s => s.id === id);
            if (station && station.isOccupied) {
                const student = appData.students.find(s => s.id === station.assignedTo.id);
                if (student) {
                    student.stationHistory.push({
                        stationId: station.id,
                        startTime: new Date(station.sessionEndTime - station.sessionDuration * 60000).toISOString(),
                        endTime: new Date().toISOString(),
                    });
                }
                appData.stationUsageHistory.push({
                    stationId: station.id,
                    studentId: station.assignedTo.id,
                    startTime: new Date(station.sessionEndTime - station.sessionDuration * 60000).toISOString(),
                    endTime: new Date().toISOString(),
                    duration: (Date.now() - (station.sessionEndTime - station.sessionDuration * 60000)) / 60000
                });
                station.isOccupied = false;
                station.assignedTo = null;
                station.assignedBy = null;
                station.sessionEndTime = null;
                station.sessionDuration = null;
                alert(`STATION ${id} HAS BEEN UNASSIGNED FROM ${student.name}.`);
                renderStationStatusAdmin();
                renderStationStatusSupervisor();
                renderStationSelectors();
                logActivity(`${unassignedBy.toUpperCase()} UNASSIGNED STATION ${id} FROM STUDENT ${student.name}.`);
            }
        };
        function generateReport() {
            const totalSupervisors = appData.supervisors.length;
            const totalStudents = appData.students.length;
            const totalStations = appData.stations.length;
            const occupiedStations = appData.stations.filter(s => s.isOccupied).length;
            const unoccupiedStations = totalStations - occupiedStations;
            document.getElementById('report-supervisors').textContent = totalSupervisors;
            document.getElementById('report-students').textContent = totalStudents;
            document.getElementById('report-total-stations').textContent = totalStations;
            document.getElementById('report-occupied-stations').textContent = occupiedStations;
            document.getElementById('report-unoccupied-stations').textContent = unoccupiedStations;
            logActivity('ADMIN GENERATED A SYSTEM REPORT.');
        }
        customReportForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const startDate = new Date(e.target['report-start-date'].value);
            const endDate = new Date(e.target['report-end-date'].value);
            const metrics = Array.from(e.target.querySelectorAll('input[name="metric"]:checked')).map(cb => cb.value);
            let reportHtml = '<h3>CUSTOM REPORT</h3>';
            reportHtml += `<p>Date Range: ${startDate.toDateString()} to ${endDate.toDateString()}</p>`;
            const filteredHistory = appData.stationUsageHistory.filter(h => new Date(h.startTime) >= startDate && new Date(h.endTime) <= endDate);
            if (metrics.includes('mostUsed') || metrics.includes('leastUsed')) {
                const usageCounts = filteredHistory.reduce((acc, curr) => {
                    acc[curr.stationId] = (acc[curr.stationId] || 0) + 1;
                    return acc;
                }, {});
                const sortedStations = Object.entries(usageCounts).sort(([, a], [, b]) => b - a);
                if (metrics.includes('mostUsed')) {
                    reportHtml += `<h4>MOST USED STATIONS:</h4><ol>`;
                    sortedStations.slice(0, 5).forEach(([stationId, count]) => {
                        reportHtml += `<li>STATION ${stationId}: ${count} TIMES</li>`;
                    });
                    reportHtml += `</ol>`;
                }
                if (metrics.includes('leastUsed')) {
                    const leastUsed = sortedStations.slice(-5).reverse();
                    reportHtml += `<h4>LEAST USED STATIONS:</h4><ol>`;
                    leastUsed.forEach(([stationId, count]) => {
                        reportHtml += `<li>STATION ${stationId}: ${count} TIMES</li>`;
                    });
                    reportHtml += `</ol>`;
                }
            }
            if (metrics.includes('averageSession')) {
                const totalDuration = filteredHistory.reduce((sum, h) => sum + h.duration, 0);
                const avgDuration = filteredHistory.length > 0 ? (totalDuration / filteredHistory.length).toFixed(2) : 0;
                reportHtml += `<h4>AVERAGE SESSION TIME:</h4><p>${avgDuration} MINUTES</p>`;
            }
            customReportOutput.innerHTML = reportHtml;
            customReportOutput.style.display = 'block';
            logActivity('ADMIN GENERATED A CUSTOM REPORT.');
        });
        function logActivity(message) {
            const time = new Date().toLocaleTimeString();
            const li = document.createElement('li');
            li.textContent = `[${time}] ${message}`;
            activityLog.prepend(li);
        }
        broadcastForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const message = e.target['broadcast-message-input'].value;
            appData.broadcastMessage = message;
            alert('BROADCAST MESSAGE SENT TO ALL SUPERVISORS.');
            logActivity(`ADMIN SENT AN EMERGENCY BROADCAST: "${message}"`);
            e.target.reset();
        });
        window.dismissBroadcast = () => {
            appData.broadcastMessage = null;
            broadcastMessageEl.style.display = 'none';
        };
        // --- Supervisor Dashboard Functions ---
        function renderSupervisorDashboard() {
            renderSupervisorProfile();
            renderStationSelectors();
            renderStationStatusSupervisor();
            renderChat(supervisorChatBox, 'supervisor');
            if (appData.broadcastMessage) {
                broadcastTextEl.textContent = appData.broadcastMessage;
                broadcastMessageEl.style.display = 'block';
            }
        }
        function renderSupervisorProfile() {
            const supervisor = appData.supervisors.find(sup => sup.id === appData.currentUser.id);
            if (supervisor && supervisor.photo) {
                supervisorProfilePhoto.innerHTML = `<img src="${supervisor.photo}" alt="${supervisor.name}" style="width: 48px; height: 48px; border-radius: 50%; object-fit: cover;">`;
            } else {
                supervisorProfilePhoto.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="#00ff00" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-user"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>`;
            }
        }
        function renderStationSelectors() {
            stationSelect.innerHTML = '<option value="">SELECT A STATION</option>';
            issueStationSelect.innerHTML = '<option value="">SELECT A STATION</option>';
            appData.stations.forEach(station => {
                const option = document.createElement('option');
                option.value = station.id;
                option.textContent = `STATION ${station.id}`;
                if (station.isOccupied) {
                    option.disabled = true;
                    option.textContent += ' (OCCUPIED)';
                }
                stationSelect.appendChild(option);
                const issueOption = document.createElement('option');
                issueOption.value = station.id;
                issueOption.textContent = `STATION ${station.id}`;
                if(station.statusFlag){
                    issueOption.textContent += ` (${station.statusFlag})`;
                }
                issueStationSelect.appendChild(issueOption);
            });
        }
        studentLookupInput.addEventListener('input', () => {
            const studentLookup = studentLookupInput.value.trim();
            const student = appData.students.find(s => s.id === studentLookup || s.name.toLowerCase() === studentLookup.toLowerCase());
            if (student) {
                studentProfilePreview.style.display = 'flex';
                studentPhotoPreview.src = student.photo || 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMDgiIGhlaWdodD0iMTA4IiB2aWV3Qm94PSIwIDAgMjQgMjQiIGZpbGw9Im5vbmUiIHN0cm9rZT0iIzAwZmYwMCIgc3Ryb2tlLXdpZHRoPSIyIiBzdHJva2UtbGluZWNhcD0icm91bmQiIHN0cm9rZS1saW5lam9pbj0icm91bmQiIGNsYXNzPSJsdWNpZGUgbHVjaWRlLXVzZXIiPjxwYXRoIGQ9Ik0xOSAyMXYtMmE0IDQgMCAwIDAtNC00SDlhNCA0IDAgMCAwLTQgNHYyIi8+PGNpcmNsZSBjeD0iMTIiIGN5PSI3IiByPSI0Ii8+PC9zdmc+';
                studentDetailsPreview.innerHTML = `
                    <p class="text-xl text-neon-green">${student.name}</p>
                    <p class="text-sm">ID: ${student.id}</p>
                    <p class="text-sm">Hostel: ${student.hostel}</p>
                `;
                studentLookupMessage.textContent = '';
            } else {
                studentProfilePreview.style.display = 'none';
                studentLookupMessage.textContent = 'STUDENT NOT FOUND. PLEASE CHECK THE ID OR NAME.';
                studentLookupMessage.className = 'text-center text-neon-red mt-2';
            }
        });
        stationAssignmentForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const stationId = parseInt(e.target['station-select'].value);
            const studentLookup = e.target['student-lookup-input'].value;
            const duration = parseInt(e.target['session-duration'].value);
            const student = appData.students.find(s => s.id === studentLookup || s.name.toLowerCase() === studentLookup.toLowerCase());
            if (!student) {
                studentLookupMessage.textContent = 'ERROR: STUDENT DOES NOT EXIST IN THE SYSTEM.';
                studentLookupMessage.className = 'text-center text-neon-red mt-2';
                return;
            }
            const station = appData.stations.find(s => s.id === stationId);
            if (station && !station.isOccupied) {
                station.isOccupied = true;
                station.assignedTo = student;
                station.assignedBy = appData.currentUser.name;
                station.sessionEndTime = Date.now() + duration * 60000;
                station.sessionDuration = duration;
                studentLookupMessage.textContent = `SUCCESS: STATION ${stationId} ASSIGNED TO ${student.name}.`;
                studentLookupMessage.className = 'text-center text-neon-green mt-2';
                stationAssignmentForm.reset();
                studentProfilePreview.style.display = 'none';
                renderStationStatusSupervisor();
                renderStationSelectors();
                renderStationStatusAdmin();
                logActivity(`SUPERVISOR ${appData.currentUser.name} ASSIGNED STATION ${stationId} TO STUDENT ${student.name} for ${duration} minutes.`);
            } else {
                studentLookupMessage.textContent = 'STATION IS ALREADY OCCUPIED OR INVALID.';
                studentLookupMessage.className = 'text-center text-neon-red mt-2';
            }
        });
        function renderStationStatusSupervisor() {
            stationStatusSupervisor.innerHTML = '';
            appData.stations.forEach(station => {
                let statusClass = station.isOccupied ? 'occupied' : 'unoccupied';
                if (station.statusFlag) {
                    statusClass = 'needs-maintenance';
                }
                const statusText = station.isOccupied ? 'OCCUPIED' : (station.statusFlag ? station.statusFlag.toUpperCase() : 'UNOCCUPIED');
                const assignedDetails = station.isOccupied ? `
                    <p class="text-sm">BY: ${station.assignedTo.name}</p>
                    <p class="text-sm">TIME LEFT: <span id="timer-${station.id}-supervisor">--:--</span></p>
                    <button onclick="unassignStation(${station.id}, 'supervisor')" class="btn-danger w-full mt-2" style="font-size: 0.75rem; padding: 0.25rem;">UNASSIGN</button>
                ` : '';
                const issueDetails = station.issue ? `
                    <p class="text-xs text-neon-yellow mt-2">ISSUE: ${station.issue}</p>
                ` : '';
                const stationCard = document.createElement('div');
                stationCard.className = `station-card ${statusClass}`;
                stationCard.innerHTML = `
                    <h3 class="text-xl font-bold">STATION ${station.id}</h3>
                    <p class="text-sm font-bold">${statusText}</p>
                    ${assignedDetails}
                    ${issueDetails}
                `;
                stationStatusSupervisor.appendChild(stationCard);
            });
        }
        issueReportForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const stationId = parseInt(e.target['issue-station-select'].value);
            const statusFlag = e.target['issue-type'].value;
            const description = e.target['issue-description'].value;
            const station = appData.stations.find(s => s.id === stationId);
            if (station) {
                station.statusFlag = statusFlag;
                station.issue = description;
                appData.maintenanceLog.push({
                    stationId: station.id,
                    reportedBy: appData.currentUser.name,
                    statusFlag: statusFlag,
                    description: description,
                    date: new Date()
                });
                alert(`ISSUE REPORTED FOR STATION ${stationId}: ${description}`);
                issueReportForm.reset();
                renderStationStatusSupervisor();
                renderStationStatusAdmin();
                renderStationSelectors();
                logActivity(`SUPERVISOR ${appData.currentUser.name} REPORTED AN ISSUE WITH STATION ${stationId} (${statusFlag}).`);
            }
        });
        supervisorChangePasswordBtn.addEventListener('click', () => {
            passwordChangeModal.style.display = 'block';
        });
        cancelChangeBtn.addEventListener('click', () => {
            passwordChangeModal.style.display = 'none';
        });
        passwordChangeForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const currentPassword = e.target['current-password'].value;
            const newPassword = e.target['new-password'].value;
            const supervisor = appData.supervisors.find(sup => sup.id === appData.currentUser.id);
            const changePasswordMessage = document.getElementById('change-password-message');
            if (supervisor && supervisor.password === currentPassword) {
                supervisor.password = newPassword;
                passwordChangeModal.style.display = 'none';
                changePasswordMessage.textContent = '';
                alert('PASSWORD CHANGED SUCCESSFULLY!');
                logActivity(`PASSWORD FOR SUPERVISOR ${supervisor.name} WAS CHANGED.`);
            } else {
                changePasswordMessage.textContent = 'INVALID CURRENT PASSWORD.';
            }
        });
        // --- Student Kiosk Functions ---
        function renderKioskStations() {
            kioskStationList.innerHTML = '';
            appData.stations.forEach(station => {
                let statusClass = station.isOccupied ? 'occupied' : 'unoccupied';
                if (station.statusFlag) {
                    statusClass = 'needs-maintenance';
                }
                const statusText = station.isOccupied ? 'OCCUPIED' : (station.statusFlag ? station.statusFlag.toUpperCase() : 'UNOCCUPIED');
                const stationCard = document.createElement('div');
                stationCard.className = `kiosk-card station-card ${statusClass}`;
                stationCard.innerHTML = `
                    <h3 class="text-xl font-bold">STATION ${station.id}</h3>
                    <p class="text-sm font-bold">${statusText}</p>
                `;
                kioskStationList.appendChild(stationCard);
            });
        }
        // --- Session Timer Functions ---
        function startSessionTimers() {
            clearInterval(sessionTimerInterval);
            sessionTimerInterval = setInterval(() => {
                const now = Date.now();
                appData.stations.forEach(station => {
                    if (station.isOccupied) {
                        const timeLeftMs = station.sessionEndTime - now;
                        if (timeLeftMs <= 0) {
                            unassignStation(station.id, 'auto-timer');
                        } else {
                            const minutes = Math.floor(timeLeftMs / 60000);
                            const seconds = Math.floor((timeLeftMs % 60000) / 1000);
                            const timerElAdmin = document.getElementById(`timer-${station.id}-admin`);
                            if (timerElAdmin) {
                                timerElAdmin.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                            }
                            const timerElSupervisor = document.getElementById(`timer-${station.id}-supervisor`);
                            if (timerElSupervisor) {
                                timerElSupervisor.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                            }
                        }
                    }
                });
            }, 1000);
        }
        // --- Chat Functions ---
        function renderChat(chatBox, userRole) {
            chatBox.innerHTML = '';
            appData.chatMessages.forEach(msg => {
                const messageDiv = document.createElement('div');
                messageDiv.className = `chat-message ${msg.role === 'admin' ? 'admin' : 'supervisor'}`;
                messageDiv.innerHTML = `<p class="font-bold">${msg.sender}:</p><p>${msg.text}</p><p style="text-align: right; font-size: 0.75rem; opacity: 0.7;">${msg.time}</p>`;
                chatBox.appendChild(messageDiv);
            });
            chatBox.scrollTop = chatBox.scrollHeight;
            if (userRole === 'admin') {
                lastAdminMessageTime = Date.now();
                adminChatNotification.style.display = 'none';
            } else if (userRole === 'supervisor') {
                lastSupervisorMessageTime = Date.now();
                supervisorChatNotification.style.display = 'none';
            }
        }
        adminChatForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const input = document.getElementById('admin-chat-input');
            const message = {
                sender: 'ADMIN',
                role: 'admin',
                text: input.value,
                time: new Date().toLocaleTimeString()
            };
            appData.chatMessages.push(message);
            input.value = '';
            renderChat(adminChatBox, 'admin');
            if (supervisorDashboard.style.display === 'none' || lastSupervisorMessageTime < Date.now()) {
                supervisorChatNotification.style.display = 'block';
            }
        });
        supervisorChatForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const input = document.getElementById('supervisor-chat-input');
            const message = {
                sender: appData.currentUser.name,
                role: 'supervisor',
                text: input.value,
                time: new Date().toLocaleTimeString()
            };
            appData.chatMessages.push(message);
            input.value = '';
            renderChat(supervisorChatBox, 'supervisor');
            if (adminDashboard.style.display === 'none' || lastAdminMessageTime < Date.now()) {
                adminChatNotification.style.display = 'block';
            }
        });
        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            initializeData();
            updateWelcomeMessage();
            toggleLoginForms('admin');
        });
    </script>
</body>
</html>


